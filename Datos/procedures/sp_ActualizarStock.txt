CREATE OR ALTER PROCEDURE dbo.sp_ActualizarStock
    @id_producto INT,
    @lote NVARCHAR(50) = NULL,
    @vencimiento DATE = NULL,
    @cantidad INT
AS
BEGIN
    SET NOCOUNT ON;
    -- Inserta un registro de stock (si ya existe lote+vencimiento podría sumar según reglas)
    INSERT INTO Stock_Productos (id_producto, lote, vencimiento, cantidad, fecha_ingreso)
    VALUES (@id_producto, @lote, @vencimiento, @cantidad, CAST(GETDATE() AS DATE));

    INSERT INTO Movimientos_Stock (id_producto, lote, vencimiento, fecha, tipo, cantidad, observaciones)
    VALUES (@id_producto, @lote, @vencimiento, CAST(GETDATE() AS DATE), 'Entrada', @cantidad, 'Ingreso por ajuste/compra');
END
GO