CREATE OR ALTER PROCEDURE dbo.sp_RegistrarScrap
    @id_producto INT,
    @lote NVARCHAR(50) = NULL,
    @vencimiento DATE = NULL,
    @cantidad INT,
    @motivo NVARCHAR(100),
    @usuario NVARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO Scrap (id_producto, lote, vencimiento, fecha, motivo, cantidad, usuario)
    VALUES (@id_producto, @lote, @vencimiento, CAST(GETDATE() AS DATE), @motivo, @cantidad, @usuario);

    DECLARE @remaining INT = @cantidad;
    WHILE @remaining > 0
    BEGIN
        DECLARE @id_stock INT, @stock_cantidad INT;
        SELECT TOP 1 @id_stock = id_stock, @stock_cantidad = cantidad
        FROM Stock_Productos
        WHERE id_producto = @id_producto AND cantidad > 0
        ORDER BY CASE WHEN vencimiento IS NULL THEN '9999-12-31' ELSE CONVERT(VARCHAR(10), vencimiento, 120) END ASC;

        IF @id_stock IS NULL BREAK;

        IF @stock_cantidad > @remaining
        BEGIN
            UPDATE Stock_Productos SET cantidad = cantidad - @remaining WHERE id_stock = @id_stock;
            SET @remaining = 0;
        END
        ELSE
        BEGIN
            UPDATE Stock_Productos SET cantidad = 0 WHERE id_stock = @id_stock;
            SET @remaining = @remaining - @stock_cantidad;
        END
    END

    INSERT INTO Movimientos_Stock (id_producto, lote, vencimiento, fecha, tipo, cantidad, observaciones)
    VALUES (@id_producto, @lote, @vencimiento, CAST(GETDATE() AS DATE), 'Salida', @cantidad, CONCAT('Scrap: ', @motivo, CASE WHEN @usuario IS NULL THEN '' ELSE CONCAT(' por ', @usuario) END));
END
GO