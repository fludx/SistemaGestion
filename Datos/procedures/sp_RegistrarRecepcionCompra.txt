CREATE OR ALTER PROCEDURE dbo.sp_RegistrarRecepcionCompra
    @id_orden_compra INT,
    @usuario NVARCHAR(100) = NULL
AS
BEGIN
    SET NOCOUNT ON;
    -- Insertar cada detalle al stock y generar movimientos
    INSERT INTO Stock_Productos (id_producto, lote, vencimiento, cantidad, fecha_ingreso)
    SELECT d.id_producto, d.lote, d.vencimiento, d.cantidad, CAST(GETDATE() AS DATE)
    FROM Ordenes_Compra_Detalle d
    WHERE d.id_orden_compra = @id_orden_compra;

    INSERT INTO Movimientos_Stock (id_producto, lote, vencimiento, fecha, tipo, cantidad, observaciones)
    SELECT d.id_producto, d.lote, d.vencimiento, CAST(GETDATE() AS DATE), 'Entrada', d.cantidad,
           CONCAT('Recepci√≥n OC #', @id_orden_compra, CASE WHEN @usuario IS NULL THEN '' ELSE CONCAT(' por ', @usuario) END)
    FROM Ordenes_Compra_Detalle d
    WHERE d.id_orden_compra = @id_orden_compra;

    UPDATE Ordenes_Compra SET estado = 'Recibida' WHERE id_orden_compra = @id_orden_compra;
END
GO