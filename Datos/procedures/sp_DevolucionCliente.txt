CREATE OR ALTER PROCEDURE dbo.sp_DevolucionCliente
    @id_orden_venta INT,
    @id_producto INT,
    @fecha DATE,
    @motivo NVARCHAR(200) = NULL,
    @cantidad INT
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO Devoluciones_Cliente (id_orden_venta, id_producto, fecha, motivo, cantidad)
    VALUES (@id_orden_venta, @id_producto, @fecha, @motivo, @cantidad);

    INSERT INTO Stock_Productos (id_producto, lote, vencimiento, cantidad, fecha_ingreso)
    VALUES (@id_producto, NULL, NULL, @cantidad, CAST(GETDATE() AS DATE));

    INSERT INTO Movimientos_Stock (id_producto, lote, vencimiento, fecha, tipo, cantidad, observaciones)
    VALUES (@id_producto, NULL, NULL, CAST(GETDATE() AS DATE), 'Entrada', @cantidad, CONCAT('Devoluci√≥n Cliente OV #', @id_orden_venta));
END
GO